<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kỷ Niệm 9 Năm - Phi Bảo & Ái Nhi</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        canvas {
            display: block;
        }

        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            font-size: 16px;
            margin: 0 0 10px 0;
            color: #ff4d6d;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        label {
            display: block;
            font-size: 11px;
            margin-bottom: 5px;
            opacity: 0.7;
        }

        input[type="color"] {
            width: 100%;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: transparent;
        }

        #status {
            font-size: 12px;
            color: #ff4d6d;
            font-weight: bold;
            margin-top: 10px;
        }

        #video-input {
            display: none;
        }

        #canvas-output {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 180px;
            height: 135px;
            border-radius: 12px;
            border: 2px solid #ff4d6d;
            transform: scaleX(-1);
            background: #000;
        }

        .instructions {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 14px;
            text-align: center;
            pointer-events: none;
            background: rgba(255, 77, 109, 0.3);
            padding: 10px 25px;
            border-radius: 30px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body>

    <div id="ui-container">
        <h1>Forever Together</h1>
        <div class="control-group">
            <label>MÀU TRÁI TIM & CHỮ</label>
            <input type="color" id="particleColor" value="#ff4d6d">
        </div>
        <div id="status">Đang tải AI...</div>
    </div>

    <div class="instructions">
        Giơ 1 bàn tay lên và <b>Xòe tay</b> để hiện thông điệp ❤️
    </div>

    <video id="video-input"></video>
    <canvas id="canvas-output"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- CẤU HÌNH THREE.JS ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);
        camera.position.z = 18;

        // --- HÀM TẠO DỮ LIỆU CHỮ ---
        function createTextData(lines) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1200; canvas.height = 600;
            ctx.fillStyle = 'black'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white'; ctx.textAlign = 'center';

            const fonts = ["bold 55px Arial", "42px Arial", "italic bold 62px Arial"];
            const yPositions = [200, 310, 430];

            lines.forEach((line, i) => {
                ctx.font = fonts[i];
                ctx.fillText(line, canvas.width / 2, yPositions[i]);
            });

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            const points = [];
            for (let y = 0; y < canvas.height; y += 3) {
                for (let x = 0; x < canvas.width; x += 3) {
                    if (imageData[(y * canvas.width + x) * 4] > 128) {
                        points.push({
                            x: (x - canvas.width / 2) * 0.028,
                            y: -(y - canvas.height / 2) * 0.028,
                            z: 0
                        });
                    }
                }
            }
            return points;
        }

        const textPoints = createTextData([
            "Celebrating 9 years of marriage",
            "(December 18, 2016 - December 18, 2025)",
            "Phi Bao loves Ai Nhi"
        ]);

        // --- HỆ THỐNG HẠT ---
        const count = textPoints.length + 1500;
        const geo = new THREE.BufferGeometry();
        const pos = new Float32Array(count * 3);
        const heartTarget = new Float32Array(count * 3);
        const textTarget = new Float32Array(count * 3);

        for (let i = 0; i < count; i++) {
            // TẠO HÌNH TRÁI TIM (Công thức toán học 3D)
            const t = Math.random() * Math.PI * 2;
            // Trái tim phẳng (X, Y) và thêm độ dày (Z)
            const x = 16 * Math.pow(Math.sin(t), 3);
            const y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
            const z = (Math.random() - 0.5) * 5;

            const scale = 0.35;
            heartTarget[i * 3] = x * scale;
            heartTarget[i * 3 + 1] = y * scale;
            heartTarget[i * 3 + 2] = z * 0.5;

            // VỊ TRÍ CHỮ
            if (i < textPoints.length) {
                textTarget[i * 3] = textPoints[i].x;
                textTarget[i * 3 + 1] = textPoints[i].y;
                textTarget[i * 3 + 2] = textPoints[i].z;
            } else {
                // Hạt dư bay ra phía sau
                textTarget[i * 3] = (Math.random() - 0.5) * 50;
                textTarget[i * 3 + 1] = (Math.random() - 0.5) * 50;
                textTarget[i * 3 + 2] = -30;
            }

            pos[i * 3] = heartTarget[i * 3];
            pos[i * 3 + 1] = heartTarget[i * 3 + 1];
            pos[i * 3 + 2] = heartTarget[i * 3 + 2];
        }

        geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        const mat = new THREE.PointsMaterial({
            size: 0.12, color: 0xff4d6d, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending
        });
        const particles = new THREE.Points(geo, mat);
        scene.add(particles);

        // --- LOGIC ĐIỀU KHIỂN ---
        let blend = 0;
        let targetBlend = 0;
        let lastHandTime = Date.now();
        const COOLDOWN_TIME = 5000; // 5 giây

        const videoElement = document.getElementById('video-input');
        const canvasElement = document.getElementById('canvas-output');
        const canvasCtx = canvasElement.getContext('2d');

        const hands = new window.Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

        hands.onResults((results) => {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                lastHandTime = Date.now(); // Cập nhật thời điểm cuối cùng thấy tay
                const landmarks = results.multiHandLandmarks[0];

                // KIỂM TRA XÒE TAY: So sánh khoảng cách đầu ngón tay với lòng bàn tay
                // Đơn giản: Nếu đầu ngón trỏ (8) cao hơn gốc ngón trỏ (5) một khoảng nhất định
                const isFingerOpen = landmarks[8].y < landmarks[5].y - 0.1;

                if (isFingerOpen) {
                    targetBlend = 1;
                    document.getElementById('status').innerText = "Đã xòe tay: Hiện thông điệp";
                } else {
                    // Nếu nắm tay lại, quay về trái tim ngay lập tức
                    targetBlend = 0;
                    document.getElementById('status').innerText = "Đã nắm tay: Trái tim";
                }

                window.drawConnectors(canvasCtx, landmarks, window.HAND_CONNECTIONS, { color: '#ff4d6d', lineWidth: 2 });
                window.drawLandmarks(canvasCtx, landmarks, { color: '#ffffff', lineWidth: 1, radius: 2 });
            } else {
                // Nếu không thấy tay, kiểm tra xem đã qua 5s chưa
                if (Date.now() - lastHandTime > COOLDOWN_TIME) {
                    targetBlend = 0;
                    document.getElementById('status').innerText = "Chờ lệnh (Xòe tay)";
                }
            }
            canvasCtx.restore();
        });

        const cameraAI = new window.Camera(videoElement, {
            onFrame: async () => { await hands.send({ image: videoElement }); },
            width: 640, height: 480
        });
        cameraAI.start();

        // --- VÒNG LẶP RENDER ---
        document.getElementById('particleColor').addEventListener('input', (e) => mat.color.set(e.target.value));

        function animate() {
            requestAnimationFrame(animate);

            // Tốc độ chuyển đổi nhanh hơn (0.15 thay vì 0.05)
            blend = THREE.MathUtils.lerp(blend, targetBlend, 0.15);

            const p = geo.attributes.position.array;
            for (let i = 0; i < count; i++) {
                const i3 = i * 3;
                p[i3] = THREE.MathUtils.lerp(heartTarget[i3], textTarget[i3], blend);
                p[i3 + 1] = THREE.MathUtils.lerp(heartTarget[i3 + 1], textTarget[i3 + 1], blend);
                p[i3 + 2] = THREE.MathUtils.lerp(heartTarget[i3 + 2], textTarget[i3 + 2], blend);

                // Hiệu ứng "bay bổng" nhẹ cho các hạt
                const time = Date.now() * 0.002;
                p[i3] += Math.sin(time + i) * 0.005;
                p[i3 + 1] += Math.cos(time + i) * 0.005;
            }
            geo.attributes.position.needsUpdate = true;

            // Xoay nhẹ khi ở hình trái tim
            if (blend < 0.2) {
                particles.rotation.y += 0.01;
            } else {
                particles.rotation.y = THREE.MathUtils.lerp(particles.rotation.y, 0, 0.1);
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>

</html>